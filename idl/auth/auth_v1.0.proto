syntax="proto3";

package auth;

option go_package="/auth";

service AuthService {
  // 权限相关
  rpc CreatePermission(CreatePermissionReq) returns (Permission){}                                // 创建权限
  rpc UpdatePermission(UpdatePermissionReq) returns (Permission){}                                // 更新权限
  rpc DeletePermission(DeletePermissionReq) returns (OperationResult){}                           // 删除权限
  rpc GetPermission(GetPermissionReq) returns (Permission){}                                      // 查询权限

  // 角色相关
  rpc CreateRole(CreateRoleReq) returns (Role){}                                                  // 创建角色
  rpc UpdateRole(UpdateRoleReq) returns (Role){}                                                  // 更新角色
  rpc DeleteRole(DeleteRoleReq) returns (OperationResult){}                                       // 删除角色
  rpc GetRole(GetRoleReq) returns (Role){}                                                        // 查询角色

  // 角色权限相关
  rpc GrantPermissionToRole(GrantPermissionToRoleReq) returns (OperationResult){}                 // 给角色分配权限
  rpc RevokePermissionFromRole(RevokePermissionFromRoleReq) returns (OperationResult){}           // 移除角色的权限
  rpc GetRolePermissions(GetRolePermissionsReq) returns (GetRolePermissionsResp){}                // 查询角色所有权限

  // 用户角色相关
  rpc AssignRoleToUser(AssignRoleToUserReq) returns (OperationResult){}                           // 给用户分配角色
  rpc RemoveRoleFromUser(RemoveRoleFromUserReq) returns (OperationResult){}                       // 移除用户的角色
  rpc GetUserRoles(GetUserRolesReq) returns (GetUserRolesResp){}                                  // 查询用户所有角色

  // 用户组相关
  rpc CreateUserGroup(CreateUserGroupReq) returns (UserGroup){}                                   // 创建用户组
  rpc UpdateUserGroup(UpdateUserGroupReq) returns (UserGroup){}                                   // 更新用户组
  rpc DeleteUserGroup(DeleteUserGroupReq) returns (OperationResult){}                             // 删除用户组
  rpc GetUserGroup(GetUserGroupReq) returns (UserGroup){}                                         // 查询用户组
  rpc GetUserGroupMembers(GetUserGroupMembersReq) returns (GetUserGroupMembersResp){}             // 查询用户组成员
  rpc GetUserGroupRoles(GetUserGroupRolesReq) returns (GetUserGroupRolesResp){}                   // 查询用户组角色
  rpc AssignRoleToUserGroup(AssignRoleToUserGroupReq) returns (OperationResult){}                 // 给用户组分配角色
  rpc RemoveRoleFromUserGroup(RemoveRoleFromUserGroupReq) returns (OperationResult){}             // 移除用户组的角色
  rpc GetUserGroupPermissions(GetUserGroupPermissionsReq) returns (GetUserGroupPermissionsResp){} // 查询用户组权限

  // 用户-用户组相关
  rpc AssignUserToGroup(AssignUserToGroupReq) returns (OperationResult){}                         // 给用户分配用户组
  rpc RemoveUserFromGroup(RemoveUserFromGroupReq) returns (OperationResult){}                     // 移除用户的用户组
  rpc GetUserGroups(GetUserGroupsReq) returns (GetUserGroupsResp){}                               // 查询用户所有用户组

  // 用户权限相关
  rpc GetUserPermissions(GetUserPermissionsReq) returns(GetUserPermissionsResp){}                 // 查询用户所有权限（含角色、用户组下权限）
  rpc HasPermission(HasPermissionReq) returns (HasPermissionResp){}                               // 判断用户是否拥有某个权限
  rpc CanAccess(CanAccessReq) returns (CanAccessResp){}                                           // 判断用户是否可对某资源执行操作(ROAC)

  // 查询辅助
  rpc ListRoles(ListRolesReq) returns (ListRolesResp){}                                           // 查询所有角色
  rpc ListUserGroups(ListUserGroupsReq) returns (ListUserGroupsResp){}                            // 查询所有用户组
  rpc ListPermissions(ListPermissionsReq) returns (ListPermissionsResp){}                         // 查询所有权限

  // 令牌相关部分
  rpc IssueToken(IssueTokenReq) returns (IssueTokenResp){}                                        // 分发token
  rpc RefreshToken(RefreshTokenReq) returns (RefreshTokenResp) {}                                 // 刷新token
  rpc VerifyToken(VerifyTokenReq) returns (VerifyTokenResp) {}                                    // 验证+解析token

  // ABAC 策略相关
  rpc CreatePolicy(CreatePolicyReq) returns (OperationResult){}                                   // 创建策略
  rpc UpdatePolicy(UpdatePolicyReq) returns (OperationResult){}                                   // 更新策略
  rpc DeletePolicy(DeletePolicyReq) returns (OperationResult){}                                   // 删除策略
  rpc GetPolicy(GetPolicyReq) returns (GetPolicyResp){}                                           // 查询策略
  rpc ListPolicies(ListPoliciesReq) returns (ListPoliciesResp){}                                  // 查询所有策略

  // ABAC 策略规则相关
  rpc CreatePolicyRule(CreatePolicyRuleReq) returns (OperationResult){}                           // 创建策略规则
  rpc UpdatePolicyRule(UpdatePolicyRuleReq) returns (OperationResult){}                           // 更新策略规则
  rpc DeletePolicyRule(DeletePolicyRuleReq) returns (OperationResult){}                           // 删除策略规则
  rpc GetPolicyRule(GetPolicyRuleReq) returns (GetPolicyRuleResp){}                               // 查询策略规则
  rpc ListPolicyRules(ListPolicyRulesReq) returns (ListPolicyRulesResp){}                         // 查询策略所有的策略规则

  // 权限-策略相关
  rpc GetPermissionPolicies(GetPermissionPoliciesReq) returns (GetPermissionPoliciesResp){}       // 查询权限的所有策略
  rpc AttachPolicyToPermission(AttachPolicyToPermissionReq) returns (OperationResult){}           // 给权限分配策略
  rpc DetachPolicyFromPermission(DetachPolicyFromPermissionReq) returns (OperationResult){}       // 移除权限的策略
}

// ====================== 数据结构 ====================== //

// ---------- 通用结构 ---------- //

message OperationResult {
  bool success = 1;                        // 操作是否成功
  string code = 2;                         // 业务状态码
  string message = 3;                      // 用户提示信息
  string request_id = 4;                   // 请求追踪ID
  string timestamp = 5; // 服务器时间戳(毫秒)
}

message Role{
  string  id=1;                   // uuid主键, 16字节
  string code=2;                 // 角色唯一标识符
  string role_name=3;            // 角色名称
  string description=4;          // 角色详细描述
  bool   status=5;               // 角色是否启用： true=启用, false=禁用
}

message Permission{
  string  id=1;                   // uuid主键, 16字节
  string code=2;                 // 权限唯一标识符
  string permission_name=3;      // 权限名称
  string description=4;          // 权限详细描述
  string  parent_id=5;            // 父权限ID, 为空时表示顶级权限
  enum Type {
    API = 0;                     // 接口权限
    MENU = 1;                    // 菜单权限
    BUTTON = 2;                  // 按钮权限
    DATA = 3;                    // 数据权限
    FIELD = 4;                   // 字段权限
    MODULE = 5;                  // 模块权限
    FILE = 6;                    // 文件权限
    TASK = 7;                    // 任务权限
  }
  Type type=6;                   // 权限类型
  string resource=7;             // 权限对应资源
  string method=8;               // 权限对应方法
  bool status=9;                 // 权限是否启用： true=启用, false=禁用
  bool need_policy=10;           // 是否需要策略检验
}

message UserGroup {
  string  id=1;                   // uuid主键, 16字节
  string code=2;                 // 用户组唯一标识符
  string group_name=3;           // 用户组名称
  bool   status=4;               // 用户组是否启用： true=启用, false=禁用
  string  parent_id=5;            // 父用户组ID, 为空时表示顶级用户组
}

message UserInfo {
  string user_id = 1;             // 二进制格式的UUID (16 string)
  string username = 2;
  string nickname=3;
  string email = 4;
  string phone = 5;
  uint64 gender = 6;             // 0-未知 1-男 2-女
  string avatar = 7;
  uint64 status = 8;             // 0-正常 1-冻结
  string created_at = 9;
  string updated_at = 10;
  bool is_deleted = 11;          // 是否已删除
}

message Policy {
  string id = 1;                  // uuid主键, 16字节
  string policy_code = 2;         // 策略唯一标识符
  string policy_name = 3;         // 策略名称
  string description = 4;         // 策略描述
  bool status = 5;                // 策略状态： true=启用, false=禁用
}

message PolicyRule {
  string id = 1;                  // uuid主键, 16字节
  string policy_code = 2;         // 所属策略唯一标识符
  string attribute_type = 3;      // 属性类型
  string attribute_key = 4;       // 属性键
  string attribute_value = 5;     // 属性值
  string operator = 6;            // 操作符
  bool status = 7;                // 规则是否启用
}

// ---------- 权限相关 ---------- //

message CreatePermissionReq{
  Permission permission=2; // 权限信息
  string request_user_id=3; // 创建者用户ID(16字节UUID)
}

message UpdatePermissionReq{
  Permission permission=2; // 权限信息
  string request_user_id=3; // 更新者用户ID(16字节UUID)
}

message DeletePermissionReq{
  string permission_code=2; // 权限唯一标识符
  string request_user_id=3;  // 删除者用户ID(16字节UUID)
}

message GetPermissionReq{
  string permission_code=2; // 权限唯一标识符
  string request_user_id=3;  // 查询者用户ID(16字节UUID)
}

// ---------- 角色相关 ---------- //

message CreateRoleReq{
  Role role=2;              // 角色信息
  string request_user_id=3;  // 创建者用户ID(16字节UUID)
}

message UpdateRoleReq{
  Role role=2;              // 角色信息
  string request_user_id=3;  // 更新者用户ID(16字节UUID)
}

message DeleteRoleReq{
  string role_code=2;       // 角色唯一标识符
  string request_user_id=3;  // 删除者用户ID(16字节UUID)
}

message GetRoleReq{
  string role_code=2;       // 角色唯一标识符
  string request_user_id=3;  // 查询者用户ID(16字节UUID)
}

// ---------- 角色权限相关 ---------- //

message GrantPermissionToRoleReq{
  string role_code=2;          // 角色唯一标识符
  string permission_code=3;    // 权限唯一标识符
  string request_user_id=4;     // 操作者用户ID(16字节UUID)
}

message RevokePermissionFromRoleReq{
  string role_code=2;          // 角色唯一标识符
  string permission_code=3;    // 权限唯一标识符
  string request_user_id=4;     // 操作者用户ID(16字节UUID)
}

message GetRolePermissionsReq{
  string role_code=2;          // 角色唯一标识符
  string request_user_id=3;     // 查询者用户ID(16字节UUID)
}

message GetRolePermissionsResp{
  repeated Permission permissions=1;
}

// ---------- 用户角色相关 ---------- //

message AssignRoleToUserReq{
  string target_user_id=2;       // 目标用户ID(16字节UUID)
  string role_code=3;           // 角色唯一标识符
  string request_user_id=4;      // 操作者用户ID(16字节UUID)
}

message RemoveRoleFromUserReq{
  string target_user_id=2;       // 目标用户ID(16字节UUID)
  string role_code=3;           // 角色唯一标识符
  string request_user_id=4;      // 操作者用户ID(16字节UUID)
}

message GetUserRolesReq{
  string target_user_id=2;       // 目标用户ID(16字节UUID)
  string request_user_id=3;      // 查询者用户ID(16字节UUID)
}

message GetUserRolesResp{
  repeated Role roles=1;
}

// ---------- 用户组相关 ---------- //

message CreateUserGroupReq{
  UserGroup user_group=2;   // 用户组信息
  string request_user_id=3;  // 创建者用户ID(16字节UUID)
}

message UpdateUserGroupReq{
  UserGroup user_group=2;   // 用户组信息
  string request_user_id=3;  // 更新者用户ID(16字节UUID)
}

message DeleteUserGroupReq{
  string user_group_code=2;    // 用户组唯一标识符
  string request_user_id=3;     // 删除者用户ID(16字节UUID)
}

message GetUserGroupReq{
  string user_group_code=2;    // 用户组唯一标识符
  string request_user_id=3;     // 查询者用户ID(16字节UUID)
}

message GetUserGroupMembersReq{
  string user_group_code=2;    // 用户组唯一标识符
  string request_user_id=3;     // 查询者用户ID(16字节UUID)
}

message GetUserGroupRolesReq{
  string user_group_code=2;    // 用户组唯一标识符
  string request_user_id=3;     // 查询者用户ID(16字节UUID)
}

message GetUserGroupRolesResp{
  repeated Role roles=1;
}

message AssignRoleToUserGroupReq{
  string user_group_code=2;     // 用户组唯一标识符
  string role_code=3;           // 角色唯一标识符
  string request_user_id=4;      // 操作者用户ID(16字节UUID)
}

message RemoveRoleFromUserGroupReq{
  string user_group_code=2;     // 用户组唯一标识符
  string role_code=3;           // 角色唯一标识符
  string request_user_id=4;      // 操作者用户ID(16字节UUID)
}

message GetUserGroupMembersResp{
  repeated UserInfo users=1; // 用户组成员列表
  uint32 total_count=2;      // 成员总数
}

message GetUserGroupPermissionsReq{
  string user_group_code=2;    // 用户组唯一标识符
  string request_user_id=3;     // 查询者用户ID(16字节UUID)
}

message GetUserGroupPermissionsResp{
  repeated Permission permissions=1; // 用户组权限列表
}

// ---------- 用户-用户组相关 ---------- //

message AssignUserToGroupReq{
  string target_user_id=2;       // 目标用户ID(16字节UUID)
  string user_group_code=3;     // 用户组唯一标识符
  string request_user_id=4;      // 操作者用户ID(16字节UUID)
}

message RemoveUserFromGroupReq{
  string target_user_id=2;       // 目标用户ID(16字节UUID)
  string user_group_code=3;     // 用户组名唯一标识符
  string request_user_id=4;      // 操作者用户ID(16字节UUID)
}

message GetUserGroupsReq{
  string target_user_id=2;       // 目标用户ID(16字节UUID)
  string request_user_id=3;      // 查询者用户ID(16字节UUID)
}

message GetUserGroupsResp{
  repeated UserGroup user_groups=1; // 用户组列表
}

// ---------- 用户权限相关 ---------- //

message GetUserPermissionsReq{
  string target_user_id=2;       // 目标用户ID(16字节UUID)
  string request_user_id=3;      // 查询者用户ID(16字节UUID)
}

message GetUserPermissionsResp{
  repeated Permission permissions=1;
}

message HasPermissionReq{
  string target_user_id=2;      // 目标用户ID(16字节UUID)
  string permission_code=3;    // 权限唯一标识符
  string request_user_id=4;     // 查询者用户ID(16字节UUID)
}

message  HasPermissionResp{
  bool  ok=1;
}

message CanAccessReq{
  string target_user_id=2;     // 目标用户ID(16字节UUID)
  string resource=3;          // 资源标识符
  string method=4;            // 操作方法
  string request_user_id=5;    // 查询者用户ID(16字节UUID)
  uint64 user_status = 8;     // 用户状态 0-正常 1-冻结
}

message CanAccessResp{
  bool ok=1;
  bool need_policy=2;                    // 是否需要策略检验
  message PolicyRules {
    string policy_code = 1;              // 策略唯一标识符
    repeated PolicyRule rules = 2;       // 该策略下的规则列表
  }
  repeated PolicyRules policy_rules = 3; // 相关策略及其规则列表
}

// ---------- 查询辅助 ---------- //

message ListRolesReq{
  uint32 page=2;
  uint32 pageSize=3;
  string request_user_id=4;    // 查询者用户ID(16字节UUID)
}

message ListRolesResp{
  repeated Role roles=1;
}

message ListUserGroupsReq{
  uint32 page=2;
  uint32 pageSize=3;
  string request_user_id=4;    // 查询者用户ID(16字节UUID)
}

message ListUserGroupsResp{
  repeated UserGroup user_groups=1;
}

message ListPermissionsReq{
  uint32 page=2;
  uint32 pageSize=3;
  string request_user_id=4;    // 查询者用户ID(16字节UUID)
}

message ListPermissionsResp{
  repeated Permission perms=1;
}

message IssueTokenReq{
  string user_id = 1;
}

message IssueTokenResp{
  string access_token = 1;    // 访问令牌
  string refresh_token = 2;
}

message RefreshTokenReq{
  string refresh_token = 2;
}

message RefreshTokenResp{
  string access_token = 1;        // 访问令牌
  string refresh_token = 2;
  string user_id=3;               // 用户ID
  repeated string permissions=4;
  uint64 version=5;
  int64 ttl=6;
}

message VerifyTokenReq{
  string access_token=1;
}

message VerifyTokenResp{
  string user_id=1;
  repeated string permissions=2;
  uint64 version=3;
  int64 ttl=4;
}

message CreatePolicyReq{
  Policy policy = 1;
  string request_user_id = 2;
}

message UpdatePolicyReq{
  Policy policy = 1;
  string request_user_id = 2;
}

message DeletePolicyReq{
  string policy_code = 1;
  string request_user_id = 2;
}

message GetPolicyReq{
  string policy_code = 1;
  string request_user_id = 2;
}

message GetPolicyResp{
  Policy policy = 1;
}

message ListPoliciesReq{
  uint32 page = 1;
  uint32 page_size = 2;
  string request_user_id = 3;
}

message ListPoliciesResp{
  repeated Policy policies = 1;
}

message CreatePolicyRuleReq{
  PolicyRule rule = 1;
  string request_user_id = 2;
}

message UpdatePolicyRuleReq{
  PolicyRule rule = 1;
  string request_user_id = 2;
}

message DeletePolicyRuleReq{
  string rule_id = 1;
  string request_user_id = 2;
}

message GetPolicyRuleReq{
  string rule_id = 1;
  string request_user_id = 2;
}

message GetPolicyRuleResp{
  PolicyRule rule = 1;
}

message ListPolicyRulesReq{
  string policy_code = 1;
  string request_user_id = 2;
}

message ListPolicyRulesResp{
  repeated PolicyRule rules = 1;
}

message GetPermissionPoliciesReq{
  string permission_code = 1;
  string request_user_id = 2;
}

message GetPermissionPoliciesResp{
  repeated Policy policies = 1;
}

message AttachPolicyToPermissionReq{
  string permission_code = 1;
  string policy_code = 2;
  string request_user_id = 3;
}

message DetachPolicyFromPermissionReq{
  string permission_code = 1;
  string policy_code = 2;
  string request_user_id = 3;
}
