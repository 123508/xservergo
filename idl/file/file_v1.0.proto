syntax = "proto3";

package file;

option go_package = "/file";

// ====================== 服务定义 ====================== //
service FileService {
  // ---------- 文件上传模块 ---------- //
  rpc InitUpload(InitUploadReq) returns (InitUploadResp);             // 初始化上传
  rpc UploadChunk(UploadChunkReq) returns (UploadChunkResp);          // 上传分片
  rpc UploadVerify(UploadVerifyReq) returns (UploadVerifyResp);       // 完成上传
  rpc DirectUpload(DirectUploadReq) returns (DirectUploadResp);       //简单直接上传

  // ---------- 文件下载模块 ---------- //
  rpc PreDownLoad(PreDownLoadReq) returns (PreDownloadResp);          // 文件预下载
  rpc Download(DownloadReq) returns (DownloadResp);                   //文件下载

  // ---------- 文件操作模块 ---------- //
  rpc CreateFolder(CreateFolderReq) returns (FileAliasItem);            // 创建目录
  rpc RenameFile(RenameFileReq) returns (FileAliasItem);                // 重命名文件
  rpc TransferSave(TransferSaveReq) returns (TransferSaveResp);         // 文件转存(作为文件拷贝使用时请将targetUserId和requestUserId统一即可)
  rpc MoveFile(MoveFileReq) returns (FileAliasItem);                    // 移动文件

  // ---------- 回收站管理模块 ---------- //
  rpc TrashFile(FileReq) returns (FileAliasItem);                       // 移入回收站
  rpc DeleteFile(FileReq) returns (FileAliasItem);                      // 彻底删除
  rpc RestoreFile(FileReq) returns (FileAliasItem);                     // 恢复文件

  // ---------- 文件查询模块 ---------- //
  rpc GetFileMeta(FileReq) returns (FileMetaResp);                  // 获取文件元数据
  rpc ListDirectory(ListDirectoryReq) returns (FileListResp);       // 列出目录内容
  rpc SearchFiles(SearchFilesReq) returns (FileListResp);           // 搜索文件

  // ---------- 文件预览模块 ---------- //
  rpc BuildSharedUrl(FileReq)returns(PreviewUrlResp);           // 构建临时url用于分享
  rpc GetTranscodeStatus(FileReq) returns (TranscodeStatusResp);    // 获取转码状态
  rpc GenerateFilePreview(FileReq) returns (PreviewUrlResp);       // 生成文档预览

  // ---------- 存储管理模块 ---------- //
  rpc CleanTrash(CleanTrashReq) returns (CleanTrashResp);    // 清理回收站
  rpc GetStorageQuota(StorageQuotaReq) returns (StorageQuotaResp);          // 获取存储配额
}

// ====================== 数据结构 ====================== //

// ---------- 通用结构 ---------- //

message FileItem {
  string file_content_hash = 1; // 文件内容哈希值
  uint64 file_size = 2;
  string file_name = 3;
  string file_id = 4;
  uint64 status = 5;
  uint64 total=6;
  string file_type=7;
  uint64 store_type=8;
  string file_cover=9;
  string created_at=10;
}

message FileAliasItem{
  string alias_id=1;
  string user_id=2;
  string file_id=3;
  string file_name=4;
  bool   is_directory=5;
}

// ---------- 上传相关 ---------- //
message InitUploadReq {
  repeated FileItem file_list = 1; // 核心：要上传的文件列表
  string request_user_id = 2;
  string target_user_id = 3;
}

message InitUploadResp {
  repeated FileItem file_status = 1; //文件是否已经存在
  string request_id=3;       // 请求id链路
  string upload_id =4;      // 上传id
}

message UploadChunkReq {
  uint64 chunk_index = 1;
  bytes  chunk_content = 2;         // 分片内容
  string chunk_content_hash = 3;            // 分片哈希校验
  string file_id = 4;
  string request_user_id=5;
  string target_user_id=6;
  string request_id=7;
  string upload_id=8;
}

message UploadChunkResp {
  uint64 chunk_index = 1;
  bool   verified = 2;         // 分片校验结果
  string request_id=3;
}

message UploadVerifyReq {
  repeated string file_id=1;
  string target_user_id=2;
  string request_user_id=3;
  string request_id=4;
  string upload_id=5;
}

message UploadVerifyFile{
  FileItem file= 1;
  repeated uint64 need_index=2;
}

message UploadVerifyResp{
  repeated UploadVerifyFile files=1;
  repeated string fail_file_id=2;
}

message DirectUploadReq{
  FileItem file=1;
  bytes content=2;
  string request_user_id = 3;
  string target_user_id = 4;
}

message DirectUploadResp{
  FileItem file=1;
}

message TransferSaveReq{
  string alias_id=1;   // 转存的根目录
  string alias_save_root_id=2; // 转存到指定的父目录下
  string request_user_id=3;
  string target_user_id=4;
  uint64 resolution_strategy=5; //转存策略 1:默认状态,有问题失败  2:覆盖,有冲突就覆盖  3:跳过,有冲突就直接不管跳过 4:重命名,有问题就重命名为唯一文件 5:取消转存,直接返回,不做任何处理 6:自行选择保留哪一个文件
  repeated string selected_file_ids=6;   // 当 resolution_strategy 为6时，此处填写用户选择要保留的文件ID列表
  string request_id=7;
}

message ReflectFile{
  string old_file_id=1;
  string new_file_id=2;
  string file_name=3;
}

message TransferSaveResp{
  repeated ReflectFile reflects=1;
  bool  reflect_exist=2;        //是否存在矛盾
  string request_id=3;
}

message PreDownLoadReq{
  string  alias_id=1;
  string request_user_id=2;
  string target_user_id=3;
}

message DownloadMsg{
  string file_id=1;
  string chunk_id=2;
  uint64 chunk_index=3;
}

message PreDownloadResp{
  string request_id=1;
  uint64 type=2;
  repeated DownloadMsg dms=3;
  string alias_name=4;
  uint64 total=5;
}

message DownloadReq{
  DownloadMsg dm=1;
  uint64 type=2;
  string request_id=3;
  string request_user_id=4;
  string target_user_id=5;
}

message DownloadResp{
  bytes content=1;
}

// 外部存储上传相关
message UploadUrlReq {
  string file_name = 1;
  string parent_id = 2;
  uint64 file_size = 3;
  string file_md5 = 4;
  string target_user_id = 5;
  string request_user_id= 6;
}

message UploadUrlResp {
  string upload_id = 1;
  string pre_signed_url = 2; // 有效期5分钟的预签名URL
  uint64 expires_at = 3;
  string request_user_id=4;
}

message RegisterUploadReq {
  string upload_id = 1;
  string object_key = 2; // 对象存储中的路径
  string file_md5 = 3; // 文件MD5验证
  string request_user_id=4;
}

// ---------- 文件操作 ---------- //
message CreateFolderReq {
  string folder_name = 1;
  string parent_alias_id = 2;
  string target_user_id = 3;
  string request_user_id=4;
  bool   is_root=5;
}

message RenameFileReq {
  string alias_id = 1;
  string new_name = 2;
  string request_user_id=3;
  string target_user_id=4;
}

message MoveFileReq {
  string alias_id = 1;
  string new_parent_id = 2;
  string request_user_id=3;
  string target_user_id=4;
  bool   is_move_to_root=5;
}

message PreviewUrlResp{
  string preview_url = 1;     // 预览URL (带签名)
  uint64 expire_seconds = 2;   // URL有效期(秒)
  string request_user_id=3;
  string request_id = 4;
}

// ---------- 回收站管理 ---------- //
message FileReq {
  string alias_id = 1;
  string request_user_id=2;
  string target_user_id=3;
}

message FileMetaResp{
    bool   is_directory=1;
    string alias_id=2;
    string file_id=3;
    string file_name=4;
    string file_content_hash = 5; // 文件内容哈希值
    uint64 file_size = 6;
    uint64 status = 7;
    string file_type=8;
    string file_cover=9;
    string created_at=10;
    string updated_at=11;
}

// ---------- 文件查询 ---------- //
message ListDirectoryReq {
  uint64 page = 1;            // 分页页码
  uint64 page_size = 2;       // 每页数量
  string target_user_id = 3;
  string request_user_id=4;
  string alias_id=5;         // 要查询文件的根目录
  uint64 root_type=6;        // 根目录类型 1:根目录 2:非根目录 3:回收站目录
}

message FileListResp {
  repeated FileItem files = 1;
  uint64 total_count = 2;
  uint64 page = 3;
  uint64 page_size = 4;
}

message SearchFilesReq {
  string keyword = 1;
  string file_type = 2;  // 可选：按类别过滤
  uint64 page = 3;
  uint64 page_size = 4;
  string request_user_id=5;
  string target_user_id=6;
}

// ---------- 文件预览 ---------- //

message PreviewDocumentResp{
  uint64 page = 1;      //当前页数
  uint64 page_count = 2;    // 文档页数
  bool requires_transcode = 3;     // 是否需要转码
}

message TranscodeStatusResp {
  enum Status {
    PENDING = 0;    // 排队中
    PROCESSING = 1; // 处理中
    COMPLETED = 2;  // 已完成
    FAILED = 3;     // 失败
  }
  Status status = 1;
  string message = 2;         // 失败原因
  int64 progress = 3;         // 进度百分比
  string request_user_id=4;
}

// ---------- 存储管理 ---------- //
message CleanTrashReq {
  int64 days = 1; // 清理超过N天的回收站文件
  string request_user_id=2;
  string target_user_id=3;
}

message CleanTrashResp {
  uint64 deleted_count = 1; // 删除的文件数
  uint64 freed_space = 2;   // 释放的空间(字节)
}

message StorageQuotaReq{
  string request_user_id=1;
  string target_user_id=2;
}

message StorageQuotaResp {
  uint64 used_bytes = 1;    // 已使用空间
  uint64 quota_bytes = 2;   // 总配额
  double usage_percent = 3; // 使用百分比
}
