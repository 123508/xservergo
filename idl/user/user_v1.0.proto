syntax = "proto3";
package user;

import "google/protobuf/timestamp.proto";

// ====================== 服务定义 ====================== //
service UserService {
  // ---------- 认证模块 ---------- //
  rpc Register(RegisterReq) returns (OperationResult) {}                    // 用户注册
  rpc EmailLogin(EmailLoginReq) returns (LoginResp) {}                      // 邮箱登录
  rpc PhoneLogin(PhoneLoginReq) returns (LoginResp) {}                      // 手机密码登录
  rpc AccountLogin(AccountLoginReq) returns (LoginResp) {}                  // 账号登录
  rpc SmsLogin(SmsLoginReq) returns (SmsLoginResp) {}                       // 验证码登录
  rpc QrCodeLogin(QrCodeLoginReq) returns (QrCodeLoginResp) {}              // 扫码登录
  rpc ConfirmQrLogin(ConfirmQrLoginReq) returns (LoginResp) {}              // 确认扫码登录
  rpc OAuthLogin(OAuthLoginReq) returns (LoginResp) {}                      // 第三方登录
  rpc Logout(LogoutReq) returns (OperationResult) {}                        // 登出
  rpc SessionCheck(SessionCheckReq) returns (SessionStatusResp) {}          // 会话检查

  // ---------- 密码管理 ---------- //
  rpc ChangePassword(ChangePasswordReq) returns (OperationResult) {}        // 修改密码
  rpc ForgotPassword(ForgotPasswordReq) returns (OperationResult) {}        // 忘记密码
  rpc ResetPassword(ResetPasswordReq) returns (OperationResult) {}          // 重置密码

  // ---------- 绑定管理 ---------- //
  rpc StartBindEmail(StartBindEmailReq) returns (OperationResult) {}        // 预绑定邮箱
  rpc CompleteBindEmail(CompleteBindEmailReq) returns (OperationResult) {}  // 完成邮箱绑定
  rpc StartUnbindEmail(StartUnbindEmailReq) returns (OperationResult) {}    // 预解绑邮箱
  rpc CompleteUnbindEmail(CompleteUnbindEmailReq) returns (OperationResult) {} // 完成邮箱解绑
  rpc StartBindPhone(StartBindPhoneReq) returns (OperationResult) {}        // 预绑定手机
  rpc CompleteBindPhone(CompleteBindPhoneReq) returns (OperationResult) {}  // 完成手机绑定
  rpc StartChangePhone(StartChangePhoneReq)returns(OperationResult){}       // 预换绑手机
  rpc VerifyNewPhone(VerifyNewPhoneReq)returns(OperationResult){}           // 验证新手机号码
  rpc CompleteChangePhone(CompleteChangePhoneReq)returns(OperationResult){} // 完成换绑手机

  // ---------- 用户管理 ---------- //
  rpc GetUserInfo(GetUserInfoReq) returns (UserInfoResp) {}                // 获取用户信息
  rpc UpdateUserInfo(UpdateUserInfoReq) returns (OperationResult) {}       // 更新用户信息
  rpc ListUsers(ListUsersReq) returns (ListUsersResp) {}                   // 用户列表
  rpc SearchUserByNickname(SearchUserByNicknameReq) returns (SearchUserByNicknameResp){} // 根据用户昵称模糊查询

  // ---------- 账户状态 ---------- //
  rpc StartDeactivateUser(StartDeactivateReq) returns (OperationResult) {} // 预冻结用户
  rpc DeactivateUser(DeactivateUserReq) returns (OperationResult) {}       // 冻结用户
  rpc ReactivateUser(ReactivateUserReq) returns (OperationResult) {}       // 解冻用户
  rpc StartDeleteUser(StartDeleteReq) returns (OperationResult) {}         // 预删除用户
  rpc DeleteUser(DeleteUserReq) returns (OperationResult) {}               // 删除用户

  // ---------- 安全服务 ---------- //
  rpc VerifySecurityCode(VerifyCodeReq) returns (VerifyCodeResp) {}        // 验证安全码
  rpc SendVerification(SendVerificationReq) returns (OperationResult) {}   // 发送验证码
}

// ====================== 数据结构 ====================== //

// ---------- 通用结构 ---------- //
message OperationResult {
  bool success = 1;
  string code = 2;        // 业务状态码
  string message = 3;     // 用户提示信息
  string request_id = 4;  // 请求追踪ID
  google.protobuf.Timestamp timestamp = 5;    // 服务器时间戳(毫秒)
}

message UserInfo {
  bytes user_id = 1;        // 二进制格式的UUID (16 bytes)
  string username = 2;
  string nickname=3;
  string email = 4;
  string phone = 5;
  int32 gender = 6;         // 0-未知 1-男 2-女
  string avatar = 7;
  int32 status = 8;         // 0-正常 1-冻结
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
  bool is_deleted = 11;     // 是否已删除
}

enum Operator {
  OP_EQ = 0;      // =
  OP_NEQ = 1;     // !=
  OP_GT = 2;      // >
  OP_GTE = 3;     // >=
  OP_LT = 4;      // <
  OP_LTE = 5;     // <=
  OP_LIKE = 6;    // LIKE
  OP_IN = 7;      // IN
  OP_NOT_IN = 8;  // NOT IN
}

message SafeFilter {
  string field = 1;
  Operator op = 2;
  oneof value {
    string str_val = 3;
    int64 int_val = 4;
    double float_val = 5;
    bool bool_val = 6;
    int64 timestamp = 7;  // UNIX毫秒时间戳
  }
}

// ---------- 认证模块 ---------- //
message RegisterReq {
  string username = 1;
  string nickname=2;
  string password = 3;
  string confirm_password=4;
  string email = 5;
  string phone = 6;
  int32 gender = 7;  // 0-未知 1-男 2-女
}

message EmailLoginReq {
  string email = 1;
  string password = 2;
}

message PhoneLoginReq {
  string phone = 1;
  string password = 2;
}

message AccountLoginReq {
  string username = 1;
  string password = 2;
}

message LoginResp {
  string access_token = 1;
  int64 expires_in = 2;  // 过期时间(秒)
  UserInfo user_info = 3;
}

message SmsLoginReq {
  string phone = 1;
  string code = 2;         // 验证阶段提供
  LoginFlowType flow = 3;  // 流程类型
  string request_id = 4;   // 验证阶段携带
}

enum LoginFlowType {
  FLOW_REQUEST_CODE = 0;  // 请求验证码
  FLOW_VERIFY_CODE = 1;   // 验证并登录
}

message SmsLoginResp {
  oneof result {
    CodeSentInfo code_sent = 1;  // 验证码发送成功
    LoginSuccess login = 2;      // 登录成功
  }
}

message CodeSentInfo {
  string request_id = 1;
  int64 expire_time = 2;  // 过期时间戳(毫秒)
}

message LoginSuccess {
  string access_token = 1;
  UserInfo user_info = 2;
}

message QrCodeLoginReq {
  string session_id = 1;  // 扫码后提供
}

message QrCodeLoginResp {
  string qr_code_url = 1;   // 二维码图片URL
  string session_id = 2;     // 登录会话ID
  int64 expires_at = 3;      // 过期时间戳(毫秒)
}

message ConfirmQrLoginReq {
  string session_id = 1;
  bytes user_id = 2;        // 确认登录的用户
}

message OAuthLoginReq {
  string provider = 1;      // wechat/google/facebook
  string auth_code = 2;     // 授权码
}

message LogoutReq {
  bytes target_user_id = 1;
  string access_token = 2;
  bytes request_user_id=3;
}

message SessionCheckReq {
  string access_token = 1;
  bytes request_user_id=2;
}

message SessionStatusResp {
  bool is_valid = 1;
  int64 last_active = 2;  // 最后活动时间戳(毫秒)
  string device_info = 3;
}

// ---------- 密码管理 ---------- //
message ChangePasswordReq {
  bytes target_user_id = 1;
  string old_password = 2;
  string confirm_password=3;
  string new_password = 4;
  bytes request_user_id=5;
}

message ForgotPasswordReq {
  oneof identify{
    string phone=1;     // 手机号
    string email=2;     // 邮箱
    string username=3;  // 用户名
  }
}

message ResetPasswordReq {
  string verification_token = 1;  // 验证码
  string new_password = 2;
  string request_id=3;
  bytes request_user_id=4;
}

// ---------- 绑定管理 ---------- //
message StartBindEmailReq {
  bytes target_user_id = 1;
  string new_email = 2;
  bytes request_user_id=3;
}

message CompleteBindEmailReq {
  bytes target_user_id = 1;
  string new_email = 2;
  string verification_code = 3;
  string request_id=4;
  bytes request_user_id=5;
}

message StartUnbindEmailReq {
  bytes target_user_id = 1;
  bytes request_User_id=2;
}

message CompleteUnbindEmailReq {
  bytes target_user_id = 1;
  string verification_code = 2;
  string request_id=3;
  bytes request_User_id=4;
}

message StartBindPhoneReq {
  bytes target_user_id = 1;       // 当前用户ID
  string new_phone = 2;    // 要绑定的新手机号
  bytes request_User_id=3;   // 操作者ID
}

message CompleteBindPhoneReq {
  bytes target_user_id = 1;       // 当前用户ID
  string new_phone = 2;    // 要绑定的手机号
  string verification_code = 3;  // 短信验证码
  string request_id = 4;   // 预绑定返回的请求ID
  bytes request_user_id=5;
}

message StartChangePhoneReq{
  bytes target_user_id=1;
  string old_phone=2;
  bytes request_user_id=3;
}

message VerifyNewPhoneReq{
  bytes target_user_id=1;
  string new_phone=2;
  string verification_code=3;
  bytes request_user_id=4;
  string request_id=5;
}

message CompleteChangePhoneReq{
  bytes target_user_id=1;
  string new_phone=2;
  string verification_code=3;
  string request_id=4;
  bytes request_user_id=5;
}

// ---------- 用户管理 ---------- //
message GetUserInfoReq {
  oneof identifier {
    bytes target_user_id = 1;
    string username = 2;
    string email = 3;
    string phone = 4;
  }
  bytes request_user_id=5;
}

message UserInfoResp {
  OperationResult result = 1;
  UserInfo user_info = 2;
}

message UpdateUserInfoReq {
  bytes target_user_id = 1;
  optional string nickname = 2;  // 可选更新字段
  optional string avatar = 3;
  optional int32 gender = 4;     // 0-未知 1-男 2-女
  bytes last_updated_by = 5;
  bytes request_user_id=6;      // 操作者ID
}

message ListUsersReq {
  int32 page = 1;                  // 页码(从1开始)
  int32 page_size = 2;             // 每页数量
  repeated SafeFilter filters = 3; // 过滤条件
  repeated OrderBy order_by=4;     // 排序字段
  bytes request_user_id=5;
}

message OrderBy {
  string field = 1;    // 排序字段
  string direction = 2; // "asc"/"desc"
}

message ListUsersResp {
  OperationResult result = 1;
  repeated UserInfo users = 2;
  int32 total_count = 3;           // 总记录数
  int32 total_pages = 4;           // 总页数
  int32 current_page = 5;        // 当前页
}

message SearchUserByNicknameReq {
  string keyword = 1;      // 查询关键字，支持模糊匹配
  int32 page = 2;          // 页码，从1开始
  int32 page_size = 3;     // 每页数量，建议默认20
  bytes request_user_id=4;
}

message SearchUserByNicknameResp {
  repeated UserInfo users = 1;   // 匹配到的用户列表
  int32 total_count = 2;         // 总数
  int32 total_pages = 3;         // 总页数
  int32 current_page = 4;        // 当前页
}

// ---------- 账户状态 ---------- //
message StartDeactivateReq {
  bytes target_user_id = 1;
  bytes request_user_id = 2;  // 操作者ID
}

message DeactivateUserReq {
  bytes target_user_id = 1;
  bytes request_user_id = 2;
  string verification_code = 3;  // 二次验证码
  string request_id=4;
}

message ReactivateUserReq {
  string identity = 1;  // 邮箱或手机号
  string code = 2;      // 验证码
  optional string new_password = 3;  // 可选新密码
  bytes request_user_id = 4;
}

message StartDeleteReq {
  bytes target_user_id = 1;
  bytes request_user_id = 2;
}

message DeleteUserReq {
  bytes target_user_id = 1;
  bytes request_user_id = 2;
  string verification_code = 3;  // 二次验证码
  string request_id=4;
}

// ---------- 安全服务 ---------- //
message VerifyCodeReq {
  string identity = 1;  // 邮箱或手机号
  string code = 2;
  CodeType code_type = 3;
}

enum CodeType {
  CODE_LOGIN = 0;
  CODE_BIND_EMAIL = 1;
  CODE_RESET_PASSWORD = 2;
  CODE_BIND_PHONE = 3;
}

message VerifyCodeResp {
  bool valid = 1;
  string token = 2;  // 用于后续操作
}

message SendVerificationReq {
  string identity = 1;  // 邮箱或手机号
  VerificationType type = 2;
}

enum VerificationType {
  VERIFY_SMS = 0;
  VERIFY_EMAIL = 1;
}