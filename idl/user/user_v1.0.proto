syntax = "proto3";
package user;
option go_package = "/user";

// ====================== 服务定义 ====================== //
service UserService {
  // ---------- 认证模块 ---------- //
  rpc Register(RegisterReq) returns (OperationResult) {}                    // 用户注册
  rpc EmailLogin(EmailLoginReq) returns (LoginResp) {}                      // 邮箱登录
  rpc PhoneLogin(PhoneLoginReq) returns (LoginResp) {}                      // 手机密码登录
  rpc AccountLogin(AccountLoginReq) returns (LoginResp) {}                  // 账号登录
  rpc SmsLogin(SmsLoginReq) returns (SmsLoginResp) {}                       // 验证码登录
  rpc GenerateQrCode(GenerateQrCodeReq) returns (GenerateQrCodeResp) {}     // 生成二维码
  rpc QrCodePreLoginStatus(QrCodePreLoginStatusReq) returns (QrCodePreLoginStatusResp){}// 预长轮询登录状态
  rpc QrCodeLoginStatus(QrCodeLoginStatusReq) returns (QrCodeLoginStatusResp){}          // 长轮询登录状态 (客户端调用)
  rpc QrPreLogin(QrPreLoginReq)returns(QrPreLoginResp){}
  rpc ConfirmQrLogin(ConfirmQrLoginReq) returns (Empty) {}                  // 确认扫码登录
  rpc CancelQrLogin(CancelQrLoginReq) returns (Empty);                      // 取消登录 (移动端调用)
  rpc OAuthLogin(OAuthLoginReq) returns (LoginResp) {}                      // 第三方登录
  rpc Logout(LogoutReq) returns (OperationResult) {}                        // 登出
  rpc SessionCheck(SessionCheckReq) returns (SessionStatusResp) {}          // 会话检查

  // ---------- 密码管理 ---------- //
  rpc ChangePassword(ChangePasswordReq) returns (OperationResult) {}        // 修改密码
  rpc ForgotPassword(ForgotPasswordReq) returns (OperationResult) {}        // 忘记密码
  rpc ResetPassword(ResetPasswordReq) returns (OperationResult) {}          // 重置密码

  // ---------- 绑定管理 ---------- //
  rpc StartBindEmail(StartBindEmailReq) returns (OperationResult) {}        // 预绑定邮箱
  rpc CompleteBindEmail(CompleteBindEmailReq) returns (OperationResult) {}  // 完成邮箱绑定
  rpc StartChangeEmail(StartChangeEmailReq)returns(OperationResult){}       // 预换绑邮箱
  rpc VerifyNewEmail(VerifyNewEmailReq)returns(OperationResult){}           // 验证新邮箱
  rpc CompleteChangeEmail(CompleteChangeEmailReq)returns(OperationResult){} // 完成换绑邮箱
  rpc StartBindPhone(StartBindPhoneReq) returns (OperationResult) {}        // 预绑定手机
  rpc CompleteBindPhone(CompleteBindPhoneReq) returns (OperationResult) {}  // 完成手机绑定
  rpc StartChangePhone(StartChangePhoneReq)returns(OperationResult){}       // 预换绑手机
  rpc VerifyNewPhone(VerifyNewPhoneReq)returns(OperationResult){}           // 验证新手机号码
  rpc CompleteChangePhone(CompleteChangePhoneReq)returns(OperationResult){} // 完成换绑手机

  // ---------- 用户管理 ---------- //
  rpc GetUserInfoById(GetUserInfoByIdReq) returns (UserInfoResp) {}            // 获取用户信息
  rpc GetUserInfoByOthers(GetUserInfoByOthersReq) returns (UserInfoResp) {}
  rpc UpdateUserInfo(UpdateUserInfoReq) returns (OperationResult) {}       // 更新用户信息
  rpc ListUsers(ListUsersReq) returns (ListUsersResp) {}                   // 用户列表
  rpc SearchUserByNickname(SearchUserByNicknameReq) returns (SearchUserByNicknameResp){} // 根据用户昵称模糊查询

  // ---------- 账户状态 ---------- //
  rpc StartDeactivateUser(StartDeactivateReq) returns (OperationResult) {} // 预冻结用户
  rpc DeactivateUser(DeactivateUserReq) returns (OperationResult) {}       // 冻结用户
  rpc ReactivateUser(ReactivateUserReq) returns (OperationResult) {}       // 解冻用户
  rpc StartDeleteUser(StartDeleteReq) returns (OperationResult) {}         // 预删除用户
  rpc DeleteUser(DeleteUserReq) returns (OperationResult) {}               // 删除用户

  // ---------- 安全服务 ---------- //
  rpc VerifySecurityCode(VerifyCodeReq) returns (VerifyCodeResp) {}        // 验证安全码
  rpc SendVerification(SendVerificationReq) returns (OperationResult) {}   // 发送验证码
}

// ====================== 数据结构 ====================== //

// ---------- 通用结构 ---------- //
message OperationResult {
  bool success = 1;
  uint64 code = 2;        // 业务状态码
  string message = 3;     // 用户提示信息
  string request_id = 4;  // 请求追踪ID
  string timestamp = 5;   // 服务器时间戳(毫秒)
  bytes request_user_id=6;// 请求用户id
}

message UserInfo {
  bytes user_id = 1;        // 二进制格式的UUID (16 bytes)
  string username = 2;
  string nickname=3;
  string email = 4;
  string phone = 5;
  uint64 gender = 6;         // 0-未知 1-男 2-女
  string avatar = 7;
  uint64 status = 8;         // 0-正常 1-冻结
  string created_at = 9;
  string updated_at = 10;
  bool is_deleted = 11;     // 是否已删除
}

enum Operator {
  OP_EQ = 0;      // =
  OP_NEQ = 1;     // !=
  OP_GT = 2;      // >
  OP_GTE = 3;     // >=
  OP_LT = 4;      // <
  OP_LTE = 5;     // <=
  OP_LIKE = 6;    // LIKE
  OP_IN = 7;      // IN
  OP_NOT_IN = 8;  // NOT IN
}

message SafeFilter {
  string field = 1;
  Operator op = 2;
  oneof value {
    string str_val = 3;
    uint64 int_val = 4;
    double float_val = 5;
    bool bool_val = 6;
    uint64 timestamp = 7;  // UNIX毫秒时间戳
  }
}

message Empty{}

// ---------- 认证模块 ---------- //
message RegisterReq {
  string username = 1;
  string nickname=2;
  string password = 3;
  string confirm_password=4;
  string email = 5;
  string phone = 6;
  uint64 gender = 7;  // 0-未知 1-男 2-女
}

message EmailLoginReq {
  string email = 1;
  string password = 2;
}

message PhoneLoginReq {
  string phone = 1;
  string password = 2;
}

message AccountLoginReq {
  string username = 1;
  string password = 2;
}

message LoginResp {
  string access_token = 1;
  string refresh_token = 2;
  UserInfo user_info = 3;
}

message SmsLoginReq {
  string phone = 1;
  string code = 2;         // 验证阶段提供
  LoginFlowType flow = 3;  // 流程类型
  string request_id = 4;   // 验证阶段携带
  uint64 type = 5;      // 验证码发送方式 0手机号 1邮箱
}

enum LoginFlowType {
  FLOW_REQUEST_CODE = 0;  // 请求验证码
  FLOW_VERIFY_CODE = 1;   // 验证并登录
}

message SmsLoginResp {
  oneof result {
    CodeSentInfo code_sent = 1;  // 验证码发送成功
    LoginResp login = 2;      // 登录成功
  }
}

message CodeSentInfo {
  string request_id = 1;
  uint64 expire_time = 2;  // 过期时间戳(毫秒)
}

message GenerateQrCodeReq {
  string client_ip = 1;         // 客户端IP
  string user_agent = 2;        // 浏览器UA
}

message GenerateQrCodeResp {
  string qr_code_url = 1;   // 二维码图片URL
  string ticket= 2;
  string request_id = 3;
  uint64 expires_at = 4;    // 过期时间戳(毫秒)
}

message QrCodePreLoginStatusReq{
  string ticket = 1;
  uint64 timeout = 2;
  string request_id = 3;
}

message QrCodePreLoginStatusResp{
  bool ok = 1;
  bytes user_id = 2;
}

// 长轮询状态请求
message QrCodeLoginStatusReq {
  string ticket = 1;             // 票据ID(即会话ID)
  uint64 timeout = 2;            // 长轮询超时时间 (毫秒, 0=使用默认)
  string request_id = 3;
  bytes user_id = 4;
}

// 长轮询状态响应
message QrCodeLoginStatusResp {
  enum Status {
    UNKNOWN = 0;
    PENDING = 1;      // 等待扫码
    SCANNED = 2;      // 已扫码未确认
    CONFIRMED = 3;    // 已确认
    EXPIRED = 4;      // 已过期
    CANCELLED = 5;    // 已取消
    ERROR = 6;        // 错误状态
  }

  Status status = 1;              // 当前状态
  LoginResponse login_resp = 2;   // 登录响应 (仅当状态为CONFIRMED时有效)
  uint64 next_poll_in = 3;         // 下次轮询时间 (毫秒, 仅当状态未完成时)
}

// 登录响应
message LoginResponse {
  oneof result {
    LoginResp success = 1;
    LoginFailure failure = 2;
  }
}

message LoginFailure {
  uint64 code = 1;
  string message = 2;
}

message QrPreLoginReq{
  string ticket = 1;
  bytes user_id=2;
  string request_id = 3;
}

message QrPreLoginResp{
  bool ok=1;
  string request_id = 2;
}

message ConfirmQrLoginReq {
  string ticket = 1;
  bytes user_id=2;
  string request_id = 3;
}

// 取消登录请求 (移动端)
message CancelQrLoginReq {
  string ticket = 1;             // 票据ID
  bytes user_id=2;
  string request_id = 3;
}

message OAuthLoginReq {
  string provider = 1;      // wechat/google/facebook
  string auth_code = 2;     // 授权码
}

message LogoutReq {
  bytes target_user_id = 1;
  string access_token = 2;
  string refresh_token = 3;
  bytes request_user_id = 4;
}

message SessionCheckReq {
  string access_token = 1;
  string refresh_token = 2;
  bytes request_user_id = 3;
}

message SessionStatusResp {
  bool is_valid = 1;
  uint64 last_active = 2;  // 最后活动时间戳(毫秒)
  string device_info = 3;
}

// ---------- 密码管理 ---------- //
message ChangePasswordReq {
  bytes target_user_id = 1;
  string old_password = 2;
  string new_password = 3;
  bytes request_user_id=4;
}

message ForgotPasswordReq {
  oneof identify{
    string phone=1;     // 手机号
    string email=2;     // 邮箱
    string username=3;  // 用户名
  }
  uint64 type = 4;      // 验证码发送方式 0手机号 1邮箱
}

message ResetPasswordReq {
  bytes target_user_id=1;
  string verification_token = 2;  // 验证码
  string new_password = 3;
  string request_id=4;
  bytes request_user_id=5;
}

// ---------- 绑定管理 ---------- //
message StartBindEmailReq {
  bytes target_user_id = 1;
  string new_email = 2;
  bytes request_user_id=3;
}

message CompleteBindEmailReq {
  bytes target_user_id = 1;
  string new_email = 2;
  string verification_code = 3;
  string request_id=4;
  bytes request_user_id=5;
}

message StartChangeEmailReq{
  bytes target_user_id=1;
  string old_email=2;
  bytes request_user_id=3;
}

message VerifyNewEmailReq{
  bytes target_user_id=1;
  string new_email=2;
  string verification_code=3;
  bytes request_user_id=4;
  string request_id=5;
}

message CompleteChangeEmailReq{
  bytes target_user_id=1;
  string verification_code=2;
  string request_id=3;
  bytes request_user_id=4;
}

message StartBindPhoneReq {
  bytes target_user_id = 1;       // 当前用户ID
  string new_phone = 2;    // 要绑定的新手机号
  bytes request_user_id=3;   // 操作者ID
}

message CompleteBindPhoneReq {
  bytes target_user_id = 1;       // 当前用户ID
  string new_phone = 2;    // 要绑定的手机号
  string verification_code = 3;  // 短信验证码
  string request_id = 4;   // 预绑定返回的请求ID
  bytes request_user_id=5;
}

message StartChangePhoneReq{
  bytes target_user_id=1;
  string old_phone=2;
  bytes request_user_id=3;
}

message VerifyNewPhoneReq{
  bytes target_user_id=1;
  string new_phone=2;
  string verification_code=3;
  bytes request_user_id=4;
  string request_id=5;
}

message CompleteChangePhoneReq{
  bytes target_user_id=1;
  string verification_code=2;
  string request_id=3;
  bytes request_user_id=4;
}

// ---------- 用户管理 ---------- //
message GetUserInfoByIdReq {
  bytes target_user_id = 1;
  bytes request_user_id=5;
}

message GetUserInfoByOthersReq {
  oneof identifier {
    string username = 2;
    string email = 3;
    string phone = 4;
  }
  bytes request_user_id=5;
}

message UserInfoResp {
  OperationResult result = 1;
  UserInfo user_info = 2;
}

message UpdateUserInfoReq {
  bytes target_user_id = 1;
  optional string nickname = 2;  // 可选更新字段
  optional string avatar = 3;
  optional int32 gender = 4;     // 0-未知 1-男 2-女
  bytes last_updated_by = 5;
  bytes request_user_id=6;      // 操作者ID
}

message ListUsersReq {
  uint64 page = 1;                  // 页码(从1开始)
  uint64 page_size = 2;             // 每页数量
  repeated SafeFilter filters = 3; // 过滤条件
  repeated OrderBy order_by=4;     // 排序字段
  bytes request_user_id=5;
}

message OrderBy {
  string field = 1;    // 排序字段
  string direction = 2; // "asc"/"desc"
}

message ListUsersResp {
  OperationResult result = 1;
  repeated UserInfo users = 2;
  int32 total_count = 3;           // 总记录数
  int32 total_pages = 4;           // 总页数
  int32 current_page = 5;        // 当前页
}

message SearchUserByNicknameReq {
  string keyword = 1;      // 查询关键字，支持模糊匹配
  uint64 page = 2;          // 页码，从1开始
  uint64 page_size = 3;     // 每页数量，建议默认20
  bytes request_user_id=4;
}

message SearchUserByNicknameResp {
  repeated UserInfo users = 1;   // 匹配到的用户列表
  uint64 total_count = 2;         // 总数
  uint64 total_pages = 3;         // 总页数
  uint64 current_page = 4;        // 当前页
}

// ---------- 账户状态 ---------- //
message StartDeactivateReq {
  bytes target_user_id = 1;
  bytes request_user_id = 2;  // 操作者ID
}

message DeactivateUserReq {
  bytes target_user_id = 1;
  bytes request_user_id = 2;
  string verification_code = 3;  // 二次验证码
  string request_id=4;
}

message ReactivateUserReq {
  string identity = 1;  // 邮箱或手机号
  string code = 2;      // 验证码
  optional string new_password = 3;  // 可选新密码
  bytes request_user_id = 4;
}

message StartDeleteReq {
  bytes target_user_id = 1;
  bytes request_user_id = 2;
}

message DeleteUserReq {
  bytes target_user_id = 1;
  bytes request_user_id = 2;
  string verification_code = 3;  // 二次验证码
  string request_id=4;
}

// ---------- 安全服务 ---------- //
message VerifyCodeReq {
  string identity = 1;  // 邮箱或手机号
  string code = 2;
  CodeType code_type = 3;
}

enum CodeType {
  CODE_LOGIN = 0;
  CODE_BIND_EMAIL = 1;
  CODE_RESET_PASSWORD = 2;
  CODE_BIND_PHONE = 3;
}

message VerifyCodeResp {
  bool valid = 1;
  string token = 2;  // 用于后续操作
}

message SendVerificationReq {
  string identity = 1;  // 邮箱或手机号
  VerificationType type = 2;
}

enum VerificationType {
  VERIFY_SMS = 0;
  VERIFY_EMAIL = 1;
}